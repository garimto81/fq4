# First Queen 4 Remake - 성능 테스트 가이드

## 개요

100 유닛 동시 실행 시 성능 측정 및 최적화를 위한 벤치마크 시스템입니다.

## 테스트 씬

**경로**: `scenes/test/performance_test.tscn`

### 자동 벤치마크 모드

자동으로 유닛 수를 증가시키며 FPS/메모리를 측정합니다.

**유닛 수 시나리오**:
- 10 유닛
- 25 유닛
- 50 유닛
- 75 유닛
- 100 유닛

**측정 항목**:
- 평균 FPS
- 최소 FPS
- 최대 FPS
- 평균 메모리 사용량
- 최대 메모리 사용량

**각 테스트**:
1. 2초 워밍업
2. 10초 측정
3. 자동으로 다음 테스트 진행

### 수동 테스트 모드

원하는 유닛 수를 직접 스폰하여 실시간으로 성능을 확인합니다.

## 조작 방법

| 키 | 기능 |
|----|------|
| **SPACE** | 자동 벤치마크 시작 |
| **1-9** | 10-90 유닛 스폰 (10단위) |
| **0** | 100 유닛 스폰 |
| **R** | 모든 유닛 제거 및 리셋 |
| **Q** | 테스트 종료 |

## 테스트 실행 방법

### 1. Godot Editor에서 실행

```
1. Godot 4.4 실행
2. 프로젝트 열기: C:\claude\Fq4\godot
3. scenes/test/performance_test.tscn 열기
4. F5 (재생) 또는 상단 재생 버튼 클릭
```

### 2. 자동 벤치마크 실행

```
1. 테스트 씬 실행
2. SPACE 키 입력
3. 자동으로 10 → 25 → 50 → 75 → 100 유닛 순서로 테스트
4. 완료 후 output/benchmark_results.txt 확인
```

### 3. 수동 테스트

```
1. 테스트 씬 실행
2. 숫자 키로 원하는 유닛 수 스폰
   - 5 키: 50 유닛
   - 0 키: 100 유닛
3. 실시간 FPS/메모리 확인
4. R 키로 리셋 후 다른 수량 테스트
```

## 결과 확인

### 실시간 모니터링

화면 왼쪽 상단 패널:
- **FPS**: 현재 프레임레이트 (색상 코드)
  - 녹색: 60 FPS 이상
  - 노란색: 30-60 FPS
  - 빨간색: 30 FPS 미만
- **Memory**: 현재 메모리 사용량
  - 녹색: 400 MB 이하
  - 노란색: 400-500 MB
  - 빨간색: 500 MB 이상

### 벤치마크 결과 파일

**위치**: `C:\claude\Fq4\output\benchmark_results.txt`

**포함 내용**:
- 시스템 정보 (OS, CPU, GPU)
- 각 유닛 수별 상세 결과
  - 평균/최소/최대 FPS
  - 평균/최대 메모리
  - 샘플 수
  - 성능 판정
- 목표 달성 여부

**예시 출력**:
```
========================================
First Queen 4 Remake - Performance Benchmark
========================================

Results:
--------

Units: 10
  FPS - Avg: 120.0, Min: 110.0, Max: 130.0
  Memory - Avg: 150.0 MB, Max: 160.0 MB
  Status: EXCELLENT (60 FPS target)

Units: 100
  FPS - Avg: 55.0, Min: 48.0, Max: 60.0
  Memory - Avg: 420.0 MB, Max: 450.0 MB
  Status: GOOD (30 FPS target)
```

## 성능 목표

| 목표 | 조건 | 판정 |
|------|------|------|
| **Recommended (권장)** | 100 유닛 @ 60 FPS, < 500 MB | PC 권장 사양 |
| **Minimum (최소)** | 100 유닛 @ 30 FPS, < 500 MB | PC 최소 사양 |
| **Unacceptable (부족)** | 100 유닛 @ < 30 FPS | 최적화 필요 |

### 성능 판정 기준

| 판정 | 조건 |
|------|------|
| **EXCELLENT** | 평균 60 FPS 이상, 최소 50 FPS 이상 |
| **GOOD** | 평균 30 FPS 이상, 최소 25 FPS 이상 |
| **ACCEPTABLE** | 평균 30 FPS 이상이지만 불안정 |
| **POOR** | 평균 30 FPS 미만 - 최적화 필요 |

## 테스트 시나리오

### 시나리오 1: 기본 성능 확인
```
목적: 100 유닛 목표 달성 여부 확인
1. SPACE로 자동 벤치마크 실행
2. 결과 파일 확인
3. 100 유닛 테스트 결과 분석
```

### 시나리오 2: 병목 지점 찾기
```
목적: FPS 하락이 시작되는 유닛 수 파악
1. 수동 모드 사용
2. 10 유닛부터 시작
3. 10씩 증가시키며 FPS 관찰
4. 60 FPS 아래로 떨어지는 지점 확인
```

### 시나리오 3: 메모리 리크 확인
```
목적: 메모리 누수 여부 확인
1. 0 키로 100 유닛 스폰
2. 1-2분간 대기하며 메모리 관찰
3. 메모리가 계속 증가하는지 확인
4. R 키로 리셋
5. 메모리가 정상 복구되는지 확인
```

## 최적화 제안

### FPS 개선

현재 구현된 최적화:
- ✅ AI 틱 간격 (0.3초)
- ✅ 피로도 시스템으로 불필요한 연산 제거
- ✅ 상태머신 기반 효율적인 AI

추가 최적화 가능:
- [ ] 유닛 간 충돌 감지 최적화 (Spatial Hashing)
- [ ] 화면 밖 유닛 업데이트 빈도 감소
- [ ] 멀티스레딩 (Physics/AI 분리)
- [ ] 유닛 풀링 (Object Pooling)

### 메모리 개선

현재 구현:
- ✅ 유닛 제거 시 queue_free() 호출
- ✅ 단순한 시각적 표현 (ColorRect)

추가 최적화 가능:
- [ ] 오브젝트 풀링으로 재사용
- [ ] 멀리 있는 유닛 LOD (Level of Detail)
- [ ] 스프라이트 아틀라스 사용

### AI 최적화

현재 구현:
- ✅ 0.3초 틱 간격
- ✅ 피로도 기반 휴식

추가 개선:
- [ ] 그룹별 AI 업데이트 (프레임 분산)
- [ ] 화면 밖 유닛 AI 주기 늘리기
- [ ] 적 탐지 범위 동적 조절

## 트러블슈팅

### FPS가 너무 낮음

**원인**: CPU 병목
**해결**:
1. AI 틱 간격 늘리기 (0.3 → 0.5초)
2. 적 탐지 범위 줄이기
3. 화면 밖 유닛 업데이트 빈도 감소

### 메모리 계속 증가

**원인**: 메모리 누수
**해결**:
1. 유닛 제거 시 queue_free() 확인
2. 시그널 연결 해제 확인
3. GameManager.clear_all_units() 호출 확인

### 불안정한 FPS

**원인**: 순간적인 부하 (AI 결정, 경로 찾기)
**해결**:
1. AI 업데이트를 여러 프레임에 분산
2. 경로 찾기 결과 캐싱
3. 물리 연산 최적화

## 참고 파일

**스크립트**:
- `scripts/test/benchmark.gd`: 벤치마크 시스템
- `scenes/test/performance_test_controller.gd`: 테스트 컨트롤러

**핵심 시스템**:
- `scripts/units/ai_unit.gd`: AI 유닛
- `scripts/systems/unit_spawner.gd`: 유닛 스포너
- `scripts/systems/fatigue_system.gd`: 피로도 시스템

## 다음 단계

1. **자동 벤치마크 실행**: 현재 성능 기준 파악
2. **결과 분석**: 목표 달성 여부 확인
3. **병목 식별**: 프로파일러로 성능 저하 원인 찾기
4. **최적화 적용**: 위 제안 사항 구현
5. **재측정**: 개선 효과 확인

## 성능 프로파일링

Godot 내장 프로파일러 사용:
```
1. 테스트 씬 실행
2. 디버그 메뉴 > Profiler
3. CPU Time, Memory, Physics 탭 확인
4. 병목 지점 식별
```

## 결론

이 테스트 시스템으로 다음을 확인할 수 있습니다:
- ✅ 100 유닛 목표 달성 여부
- ✅ 성능 병목 지점
- ✅ 메모리 사용 패턴
- ✅ 최적화 효과 측정

목표: **100 유닛 @ 60 FPS (권장) 또는 30 FPS (최소)**
